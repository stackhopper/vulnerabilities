## Summary

Jenkins v2.527, v2.516.2 and lower are vulnerable to a remote log forging vulnerability originated on the Jenkins CLI Java routines.

## Description

The bug was discovered because of an unusual locale combination, which prompted the following error: 

`2024-06-20 22:39:18.717+0000 [id=1111267]     WARNING h.cli.CLIAction$ServerSideImpl#onLocale: unknown client locale en_AR`

Upon looking for that error string, we find a definition for the [onLocale](https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/cli/CLIAction.java#L255) method, which has a single parameter called **Text** of type String. This parameter is not sanitized before the conditional loop on like 257 of the same file, and on line 262 the output is logged directly to the Jenkins general log file (located on **/var/log/jenkins/jenkins.log**).

The log forging vulnerability is triggered by passing an arbitrary value for the OS locale. The vulnerability accepts a number of inputs:

- Octal-enconded characters (e.g. \145\156\137\101\122) 
- Multiple escape codes (\r, \t, \b, \n)
- CRLF characters

and given the parsing of the **xx_XX.ENCODING** locale and encoding formats, it has the following limitation:

- All data after a dot (escaped, unescaped and represented in another notation or encoding) will be parsed out
- Capital letters are transformed to lowercase
- Hyphens are transformed into underscores.

## Reproduction steps

1. Below is a payload that partially rewrites the original alert by leveraging the **\b** escape code to display the forged text. 

`$ defaults write -g AppleLanguages '("\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\bocation: remote connection rejected")' && java -jar jenkins-cli.jar -s [http://ci-2.invgate.com/](https://ci-2.invgate.com/) who-am-i `

```
Authenticated as: anonymous  
Authorities:  
  anonymous
```
``
The log line on **/var/log/jenkins/jenkins.log** is then rewritten and looks like this:

`2024-06-20 23:06:15.121+0000 [id=1107774] WARNING h.cli.CLIAction$ServerSideImpl#onLocation: remote connection rejected`

## Proof of concept

Proof of concept video with impact and recovery demo available [here](https://youtu.be/DU8cunHAhp4).

## Notes

- The proof of concept was created on an Intel-based MacBook Pro with Sonoma 14.1
- This payload works for anonymous and authenticated users, and successful and failed executions of the Jenkins CLI command. 
- The whole line can be rewritten by using the **\r** escape code, and new arbitrary log lines can be injected by using the **\n** 
- Though not checked, it's possible that the **onEncoding** method is vulnerable to log forging as well.

## Jenkins acknowledgement
https://jenkins.io/security/advisory/2025-09-17/
